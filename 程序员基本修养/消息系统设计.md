## 消息系统设计 ##

### 表设计 ###

#### notify 消息表 ####

| 字段名称       | 类型       | 长度   | 默认   | 备注   | 描述                       |
| ---------- | -------- | ---- | ---- | ---- | ------------------------ |
| notifyId   | int      | 11   |      |      | 消息Id                     |
| type       | smallint | 1    |      |      | 消息类型：1: 公告 ，2: 提醒 ，3: 信息 |
| title      | varchar  | 200  |      |      | 消息标题                     |
| content    | varchar  | 1024 |      |      | 消息内容                     |
| target     | int      | 11   |      |      | 目标的Id                    |
| targetType | varchar  | 20   |      |      | 目标的类型                    |
| action     | varchar  | 20   |      |      | 提醒信息的动作类型                |
| sender     | int      | 11   |      |      | 消息发送者ID                  |
| status     | smallint | 1    |      |      | 消息状态：1、启用  2、禁用  3、删除    |
| ctime      | varchar  | 19   |      |      | 消息创建时间                   |

备注：

type：消息类型，1: 公告 ，2: 提醒 ，3: 信息

> 公告：针对系统所有用户，相当于系统公告 ，
> 提醒：针对部分用户，提醒相应的用户 ，
> 信息：针对单个用户，相当于私信）

target，targetType，action：消息类型为提醒时，才会有相应记录。target，targetType记录该条提醒所关联的对象，action则记录该条提醒所关联的动作。示例：某用户发布一篇文章，其他用户评论、点赞，那么该用户将会收到相应的提醒。其中，这篇文章就是target，文章就是targetType（目标类型包括：文章、图片、评论等），评论、点赞就是action

#### user_notify 消息队列表 ####

| 字段名称         | 类型       | 长度   | 默认   | 备注   | 描述               |
| ------------ | -------- | ---- | ---- | ---- | ---------------- |
| userNotifyId | int      | 11   |      |      | 用户消息Id           |
| suId         | int      | 11   |      |      | 消息所属系统用户id       |
| notifyId     | int      | 11   |      |      | 消息id             |
| isRead       | smallint | 1    | 0    |      | 是否阅读，0：未读，1：已读   |
| readTime     | varchar  | 19   |      |      | 阅读时间             |
| isDelete     | smallint | 1    | 0    |      | 是否删除，0：未删除，1：已删除 |
| deleteTime   | varchar  | 19   |      |      | 删除时间             |
| ctime        | varchar  | 19   |      |      | 队列消息生成的时间        |

备注：

存储用户的消息队列，它关联一则消息(notify)的具体内容。

#### subscription 订阅表 ####

| 字段名称       | 类型      | 长度   | 默认   | 备注   | 描述        |
| ---------- | ------- | ---- | ---- | ---- | --------- |
| subId      | int     | 11   |      |      | 主键Id      |
| target     | int     | 11   |      |      | 目标的Id     |
| targetType | varchar | 20   |      |      | 目标的类型     |
| action     | varchar | 20   |      |      | 提醒信息的动作类型 |
| suId       | int     | 11   |      |      | 订阅人       |
| ctime      | varchar | 19   |      |      | 订阅时间      |

备注：

订阅，是从Notify表拉取消息到UserNotify的前提，用户首先订阅了某一个目标的某一个动作，在此之后产生这个目标的这个动作的消息，才会被通知到该用户。示例：某用户发布一篇文章，需要接受到评论、点赞提醒。此时，就需要两个订阅，订阅其他用户的评论、点赞行为。当其他用户评论点赞时，根据之前的订阅，就能收到相应的提醒。



### 业务流程###

#### 公告消息：####

管理员发布公告 -》用户登陆系统（或其他时间）时，拉取最新的公告消息至消息队列-》用户查看消息队列消息-》标记消息为已读。

#### 消息提醒：#### 

用户订阅消息-》创建消息提醒（其他用户的操作）-》用户登陆系统（或其他时间）时，根据订阅记录，拉取最新消息至消息队列-》标记消息为已读

#### 信息提醒：#### 

发送消息（先创建消息，然后直接把消息推入接受者的消息队列）-》接受者查看消息队列消息-》标记消息为已读



### 参考资料 ###

[消息系统设计与实现「上篇」](http://www.jianshu.com/p/f4d7827821f1)

[消息系统设计与实现「下篇」](http://www.jianshu.com/p/6bf8166b291c)